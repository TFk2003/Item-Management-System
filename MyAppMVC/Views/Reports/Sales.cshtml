@model MyAppMVC.ViewModels.SalesReportViewModel

@{
    ViewData["Title"] = "Sales Report";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-cash-stack"></i> Sales Report</h1>
            <p class="text-muted">Analyze sales performance and trends</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="window.print()">
                <i class="bi bi-printer"></i> Print
            </button>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="bi bi-funnel"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Start Date</label>
                    <input type="date" name="startDate" class="form-control" 
                           value="@Model.StartDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="date" name="endDate" class="form-control" 
                           value="@Model.EndDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Report Type</label>
                    <select class="form-select">
                        <option selected>Detailed Sales Report</option>
                        <option>Summary Report</option>
                        <option>Product-wise Report</option>
                        <option>Client-wise Report</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-filter"></i> Apply
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Sales</h6>
                    <h2 class="card-text">@Model.TotalSales.ToString("C")</h2>
                    <small>@Model.StartDate.ToString("MMM dd") - @Model.EndDate.ToString("MMM dd")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Items Sold</h6>
                    <h2 class="card-text">@Model.TotalItemsSold</h2>
                    <small>Units sold in period</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">Average Sale</h6>
                    <h2 class="card-text">@Model.AverageSaleValue.ToString("C")</h2>
                    <small>Per transaction</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Transactions</h6>
                    <h2 class="card-text">@Model.SalesData.Count</h2>
                    <small>Total orders</small>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-trophy"></i> Top Selling Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Revenue</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.TopSellingItems)
                                {
                                    var percentage = Model.TotalSales > 0 ? (item.TotalRevenue / Model.TotalSales * 100) : 0;
                                    <tr>
                                        <td>@item.ItemName</td>
                                        <td><span class="badge bg-primary">@item.QuantitySold</span></td>
                                        <td>@item.TotalRevenue.ToString("C")</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" style="width: @percentage%">
                                                    @percentage.ToString("0.0")%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-people-fill"></i> Top Clients</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Purchases</th>
                                    <th>Total Spent</th>
                                    <th>Avg. Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var client in Model.TopClients)
                                {
                                    var avgOrder = client.PurchaseCount > 0 ? client.TotalPurchases / client.PurchaseCount : 0;
                                    <tr>
                                        <td>@client.ClientName</td>
                                        <td>@client.PurchaseCount</td>
                                        <td class="text-success">@client.TotalPurchases.ToString("C")</td>
                                        <td>@avgOrder.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-receipt"></i> Detailed Sales Transactions</h5>
            <div class="btn-group">
                <a asp-controller="Reports" asp-action="Export"
                   asp-route-reportType="Sales"
                   asp-route-startDate="@Model.StartDate.ToString("yyyy-MM-dd")"
                   asp-route-endDate="@Model.EndDate.ToString("yyyy-MM-dd")"
                   class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-download"></i> Export Report
                </a>
                <button class="btn btn-sm btn-outline-danger" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="salesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Item</th>
                            <th>Client</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var sale in Model.SalesData)
                        {
                            <tr>
                                <td>@sale.PurchasedDate.ToString("MMM dd, yyyy")</td>
                                <td>@sale.Item?.Name</td>
                                <td>@sale.Client?.FirstName @sale.Client?.LastName</td>
                                <td>@sale.Quantity</td>
                                <td>@sale.UnitPrice.ToString("C")</td>
                                <td class="fw-bold text-success">@sale.TotalPrice.ToString("C")</td>
                                <td><span class="badge bg-success">Completed</span></td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="table-dark">
                            <td colspan="5" class="text-end"><strong>Total:</strong></td>
                            <td><strong>@Model.TotalSales.ToString("C")</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // function exportToCSV() {
        //     toastr.info('CSV export functionality would be implemented here');
        // }

        // function exportToPDF() {
        //     toastr.info('PDF export functionality would be implemented here');
        // }

        // Initialize DataTable
        $(document).ready(function() {
            $('#salesTable').DataTable({
                pageLength: 10,
                order: [[0, 'desc']]
            });
        });
    </script>

    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
}