@model MyAppMVC.ViewModels.FinancialReportViewModel

@{
    ViewData["Title"] = "Financial Report";
    var currentYearData = Model.YearlyComparison.FirstOrDefault(y => y.Year == Model.Year);
    var previousYearData = Model.YearlyComparison.FirstOrDefault(y => y.Year == Model.Year - 1);
    var growthRate = currentYearData?.Growth ?? 0;
    
    // Calculate items sold growth
    var itemsGrowth = 0m;
    if (previousYearData != null && previousYearData.ItemsSold > 0)
    {
        itemsGrowth = ((Model.TotalItemsSold - previousYearData.ItemsSold) / (decimal)previousYearData.ItemsSold) * 100;
    }
    
    var totalTransactions = Model.MonthlyData.Sum(m => m.TransactionCount);
    var avgTransaction = totalTransactions > 0 ? Model.TotalRevenue / totalTransactions : 0;
    
    // Calculate average transaction growth
    var prevYearAvgTransaction = previousYearData != null && previousYearData.TransactionCount > 0 
        ? previousYearData.Revenue / previousYearData.TransactionCount 
        : 0;
    var avgTransactionGrowth = prevYearAvgTransaction > 0 
        ? ((avgTransaction - prevYearAvgTransaction) / prevYearAvgTransaction) * 100 
        : 0;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-pie-chart"></i> Financial Report</h1>
            <p class="text-muted">Financial analysis and performance metrics for @Model.Year</p>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                Year: @Model.Year
            </button>
            <ul class="dropdown-menu">
                @for (int year = Model.Year - 2; year <= Model.Year + 2; year++)
                {
                    <li>
                        <a class="dropdown-item @(year == Model.Year ? "active" : "")"
                           href="@Url.Action("Financial", new { year = year })">
                            @year
                        </a>
                    </li>
                }
            </ul>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Total Revenue
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@Model.TotalRevenue.ToString("C")</div>
                            <div class="mt-2 mb-0 text-muted">
                                @if (growthRate > 0)
                                {
                                    <span class="text-success me-2">
                                        <i class="bi bi-arrow-up"></i> @growthRate.ToString("0.0")%
                                    </span>
                                }
                                else if (growthRate < 0)
                                {
                                    <span class="text-danger me-2">
                                        <i class="bi bi-arrow-down"></i> @Math.Abs(growthRate).ToString("0.0")%
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted me-2">0%</span>
                                }
                                <span>From last year</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-cash-stack fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Items Sold
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@Model.TotalItemsSold.ToString("N0")</div>
                            <div class="mt-2 mb-0 text-muted">
                                @if (itemsGrowth > 0)
                                {
                                    <span class="text-success me-2">
                                        <i class="bi bi-arrow-up"></i> @itemsGrowth.ToString("0.0")%
                                    </span>
                                }
                                else if (itemsGrowth < 0)
                                {
                                    <span class="text-danger me-2">
                                        <i class="bi bi-arrow-down"></i> @Math.Abs(itemsGrowth).ToString("0.0")%
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted me-2">0%</span>
                                }
                                <span>From last year</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-cart-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                Avg. Transaction Value
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@avgTransaction.ToString("C")</div>
                            <div class="mt-2 mb-0 text-muted">
                                @if (avgTransactionGrowth > 0)
                                {
                                    <span class="text-success me-2">
                                        <i class="bi bi-arrow-up"></i> @avgTransactionGrowth.ToString("0.0")%
                                    </span>
                                }
                                else if (avgTransactionGrowth < 0)
                                {
                                    <span class="text-danger me-2">
                                        <i class="bi bi-arrow-down"></i> @Math.Abs(avgTransactionGrowth).ToString("0.0")%
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted me-2">0%</span>
                                }
                                <span>From last year</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up-arrow fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Chart & Quarterly Performance -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart"></i> Monthly Revenue Trend - @Model.Year</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="revenueChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-calendar-event"></i> Quarterly Performance</h5>
                </div>
                <div class="card-body">
                    @{
                        var quarters = Model.MonthlyData
                            .Select((m, i) => new { Month = m, Index = i })
                            .GroupBy(x => x.Index / 3)
                            .Select(g => new
                            {
                                Quarter = g.Key + 1,
                                Revenue = g.Sum(x => x.Month.Revenue)
                            })
                            .ToList();

                        var maxRevenue = quarters.Any() ? quarters.Max(q => q.Revenue) : 1;
                    }

                    @for (int i = 0; i < quarters.Count; i++)
                    {
                        var quarter = quarters[i];
                        var growth = 0m;
                        if (i > 0 && quarters[i - 1].Revenue > 0)
                        {
                            growth = ((decimal)(quarter.Revenue - quarters[i - 1].Revenue) / (decimal) quarters[i - 1].Revenue) * 100;
                        }
                        
                        var percentage = maxRevenue > 0 ? (double)(quarter.Revenue / maxRevenue * 100) : 0;
                        var progressClass = quarter.Quarter switch
                        {
                            1 => "bg-primary",
                            2 => "bg-success",
                            3 => "bg-warning",
                            4 => "bg-danger",
                            _ => "bg-info"
                        };

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Q@(quarter.Quarter) @Model.Year</span>
                                <span class="fw-bold">@quarter.Revenue.ToString("C")</span>
                            </div>
                            <div class="progress" style="height: 15px;">
                                <div class="progress-bar @progressClass" style="width: @percentage%"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <span>
                                    @if (growth > 0)
                                    {
                                        <span class="text-success">
                                            <i class="bi bi-arrow-up"></i> @growth.ToString("0.0")%
                                        </span>
                                    }
                                    else if (growth < 0)
                                    {
                                        <span class="text-danger">
                                            <i class="bi bi-arrow-down"></i> @Math.Abs(growth).ToString("0.0")%
                                        </span>
                                    }
                                    else
                                    {
                                        <span>@(i == 0 ? "First quarter" : "No change")</span>
                                    }
                                </span>
                                <span>@percentage.ToString("0.0")% of peak</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Yearly Comparison -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-trending-up"></i> Yearly Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Revenue</th>
                                    <th>Growth</th>
                                    <th>Items Sold</th>
                                    <th>Transactions</th>
                                    <th>Avg. Revenue per Item</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var yearData in Model.YearlyComparison)
                                {
                                    var badgeClass = yearData.Performance switch
                                    {
                                        "Excellent" => "bg-success",
                                        "Very Good" => "bg-primary",
                                        "Good" => "bg-info",
                                        "Average" => "bg-warning",
                                        _ => "bg-secondary"
                                    };
                                    
                                    <tr @(yearData.Year == Model.Year ? "class=table-primary" : "")>
                                        <td>
                                            <strong>@yearData.Year</strong>
                                            @if (yearData.Year == Model.Year)
                                            {
                                                <span class="badge bg-primary">Current</span>
                                            }
                                        </td>
                                        <td class="fw-bold">@yearData.Revenue.ToString("C")</td>
                                        <td>
                                            @if (yearData.Growth > 0)
                                            {
                                                <span class="text-success">
                                                    <i class="bi bi-arrow-up"></i> @yearData.Growth.ToString("0.0")%
                                                </span>
                                            }
                                            else if (yearData.Growth < 0)
                                            {
                                                <span class="text-danger">
                                                    <i class="bi bi-arrow-down"></i> @Math.Abs(yearData.Growth).ToString("0.0")%
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>@yearData.ItemsSold.ToString("N0")</td>
                                        <td>@yearData.TransactionCount.ToString("N0")</td>
                                        <td>@yearData.AvgRevenuePerItem.ToString("C")</td>
                                        <td>
                                            <span class="badge @badgeClass">
                                                @yearData.Performance
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Financial Details -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-calendar-month"></i> Monthly Financial Details - @Model.Year</h5>
            <div class="btn-group">
                <a asp-controller="Reports" asp-action="Export"
                   asp-route-reportType="Financial"
                   asp-route-year="@Model.Year"
                   class="btn btn-sm btn-primary">
                    <i class="bi bi-file-earmark-excel"></i> Export Full Report
                </a>
                <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Revenue</th>
                            <th>% of Annual</th>
                            <th>Items Sold</th>
                            <th>Transactions</th>
                            <th>Avg. Transaction</th>
                            <th>Daily Avg. Revenue</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.MonthlyData.Count; i++)
                        {
                            var month = Model.MonthlyData[i];
                            var percentageOfAnnual = Model.TotalRevenue > 0 
                                ? (month.Revenue / Model.TotalRevenue * 100) 
                                : 0;
                            var avgTransactions = month.TransactionCount > 0 
                                ? month.Revenue / month.TransactionCount 
                                : 0;
                            var daysInMonth = DateTime.DaysInMonth(Model.Year, i + 1);
                            var dailyAvg = month.Revenue / daysInMonth;
                            
                            // Calculate trend compared to previous month
                            var trend = "Stable";
                            var trendBadgeClass = "bg-secondary";
                            var trendIcon = "bi-dash";
                            
                            if (i > 0)
                            {
                                var prevMonth = Model.MonthlyData[i - 1];
                                if (prevMonth.Revenue > 0)
                                {
                                    var change = ((month.Revenue - prevMonth.Revenue) / prevMonth.Revenue) * 100;
                                    if (change > 5)
                                    {
                                        trend = "Up";
                                        trendBadgeClass = "bg-success";
                                        trendIcon = "bi-arrow-up";
                                    }
                                    else if (change < -5)
                                    {
                                        trend = "Down";
                                        trendBadgeClass = "bg-danger";
                                        trendIcon = "bi-arrow-down";
                                    }
                                }
                                else if (month.Revenue > 0)
                                {
                                    trend = "Up";
                                    trendBadgeClass = "bg-success";
                                    trendIcon = "bi-arrow-up";
                                }
                            }
                            
                            <tr>
                                <td><strong>@month.Month</strong></td>
                                <td class="fw-bold text-success">@month.Revenue.ToString("C")</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" style="width: @percentageOfAnnual%">
                                            @percentageOfAnnual.ToString("0.0")%
                                        </div>
                                    </div>
                                </td>
                                <td>@month.ItemsSold.ToString("N0")</td>
                                <td>@month.TransactionCount.ToString("N0")</td>
                                <td>@avgTransactions.ToString("C")</td>
                                <td>@dailyAvg.ToString("C")</td>
                                <td>
                                    <span class="badge @trendBadgeClass">
                                        <i class="bi @trendIcon"></i> @trend
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-dark">
                        <tr>
                            <td><strong>Annual Total</strong></td>
                            <td><strong>@Model.TotalRevenue.ToString("C")</strong></td>
                            <td>100%</td>
                            <td><strong>@Model.TotalItemsSold.ToString("N0")</strong></td>
                            <td><strong>@totalTransactions.ToString("N0")</strong></td>
                            <td><strong>@avgTransaction.ToString("C")</strong></td>
                            <td><strong>@((Model.TotalRevenue / 365).ToString("C"))</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
            // Revenue Chart
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.MonthlyData.Select(m => m.Month))),
                    datasets: [{
                        label: 'Monthly Revenue',
                        data: @Html.Raw(Json.Serialize(Model.MonthlyData.Select(m => m.Revenue))),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Revenue: $${context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US');
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
}
